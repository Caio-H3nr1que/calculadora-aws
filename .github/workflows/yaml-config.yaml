# .github/workflows/calculator-ci.yml
# Pipeline de CI/CD para a Calculadora

name: Calculator CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Job de Testes UnitÃ¡rios
  unit-tests:
    name: Testes UnitÃ¡rios
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: Configurar Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: Instalar dependÃªncias
      run: npm install
    
    - name: Executar testes unitÃ¡rios
      run: npm run test:unit
    
    - name: Gerar relatÃ³rio de cobertura
      run: npm run test:coverage
    
    - name: Upload relatÃ³rio de cobertura
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/coverage-final.json
        flags: unittests
        name: codecov-unit-tests

  # Job de Testes de IntegraÃ§Ã£o (Jest + JSDOM)
  integration-tests:
    name: Testes de IntegraÃ§Ã£o
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
    
    - name: Instalar dependÃªncias
      run: npm ci
    
    - name: Executar testes de integraÃ§Ã£o (Jest + JSDOM)
      run: npm run test:integration
    
    - name: Upload artefatos de testes
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: |
          coverage/
          test-results/

  # Job de AnÃ¡lise de CÃ³digo
  code-quality:
    name: AnÃ¡lise de Qualidade de CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Instalar dependÃªncias
      run: npm ci
    
    - name: Executar ESLint
      run: npm run lint
      continue-on-error: true
    
    - name: Executar anÃ¡lise de seguranÃ§a
      run: npm audit --audit-level=moderate
      continue-on-error: true
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      continue-on-error: true

  # Job de Deploy (GitHub Pages)
  deploy:
    name: Deploy para GitHub Pages
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: Deploy para GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        exclude_assets: '.github,node_modules,tests,coverage,.gitignore,package*.json,jest.config.js,*.md'
    
    - name: NotificaÃ§Ã£o de deploy
      run: echo "âœ… Deploy concluÃ­do com sucesso!"

  # Job de RelatÃ³rio de Testes
  test-report:
    name: RelatÃ³rio Consolidado de Testes
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, code-quality]
    if: always()
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: Gerar relatÃ³rio consolidado
      run: |
        echo "# ðŸ§ª RelatÃ³rio Completo de Testes - Calculadora" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Pipeline executado em:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Autor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ“‹ SumÃ¡rio Executivo" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Categoria | Status | Detalhes |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ª Testes UnitÃ¡rios | ${{ needs.unit-tests.result == 'success' && 'âœ… PASSOU' || 'âŒ FALHOU' }} | Testes de funÃ§Ãµes isoladas e lÃ³gica de negÃ³cio |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”— Testes de IntegraÃ§Ã£o | ${{ needs.integration-tests.result == 'success' && 'âœ… PASSOU' || 'âŒ FALHOU' }} | Testes de interaÃ§Ã£o entre componentes (JSDOM) |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” AnÃ¡lise de Qualidade | ${{ needs.code-quality.result == 'success' && 'âœ… PASSOU' || 'âš ï¸ AVISO' }} | ESLint + Auditoria de seguranÃ§a |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ§ª Detalhamento: Testes UnitÃ¡rios" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ needs.unit-tests.result == 'success' && 'âœ… PASSOU' || 'âŒ FALHOU' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Escopo:**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ FunÃ§Ãµes matemÃ¡ticas isoladas (soma, subtraÃ§Ã£o, multiplicaÃ§Ã£o, divisÃ£o)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ OperaÃ§Ãµes especiais (potÃªncia, raiz quadrada)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ ValidaÃ§Ã£o de entrada de dados" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Tratamento de erros (divisÃ£o por zero, raiz negativa)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ FormataÃ§Ã£o de nÃºmeros decimais" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ LÃ³gica de estado da calculadora" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ambiente:**" >> $GITHUB_STEP_SUMMARY
        echo "- Framework: Jest" >> $GITHUB_STEP_SUMMARY
        echo "- Node.js: 18.x, 20.x (matriz)" >> $GITHUB_STEP_SUMMARY
        echo "- Cobertura mÃ­nima: 70%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ”— Detalhamento: Testes de IntegraÃ§Ã£o (E2E Simulados)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ needs.integration-tests.result == 'success' && 'âœ… PASSOU' || 'âŒ FALHOU' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Escopo de Testes Realizados:**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± OperaÃ§Ãµes BÃ¡sicas via Interface Simulada" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Soma atravÃ©s de cliques nos botÃµes (5 + 3 = 8)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ SubtraÃ§Ã£o atravÃ©s de cliques (9 âˆ’ 4 = 5)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ MultiplicaÃ§Ã£o atravÃ©s de cliques (6 Ã— 7 = 42)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ DivisÃ£o atravÃ©s de cliques (8 Ã· 2 = 4)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš¡ OperaÃ§Ãµes Especiais" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ CÃ¡lculo de potÃªncia (5Â² = 25)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ CÃ¡lculo de raiz quadrada (âˆš9 = 3)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Tratamento de erro: raiz de nÃºmero negativo" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âŒ¨ï¸ InteraÃ§Ã£o com Teclado" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Entrada via teclado para operaÃ§Ãµes (5+3 Enter)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Tecla Escape para limpar display" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Tecla Enter para calcular resultado" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Teclas numÃ©ricas e operadores" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ OperaÃ§Ãµes Complexas" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ CÃ¡lculos com nÃºmeros decimais (5.5 + 2.5 = 8)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ OperaÃ§Ãµes encadeadas (10+5=15, Ã—2=30, âˆ’10=20)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ DivisÃ£o por zero retorna erro" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ MÃºltiplos pontos decimais prevenidos (5.3.2 â†’ 5.32)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¨ Comportamento da Interface" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ HistÃ³rico exibido durante operaÃ§Ã£o (5+)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ HistÃ³rico limpo apÃ³s cÃ¡lculo completo" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Display reseta ao digitar novo nÃºmero apÃ³s resultado" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ BotÃ£o Clear (C) funciona corretamente" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ–¥ï¸ Responsividade e Acessibilidade (DOM)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Calculadora presente no DOM" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Todos os botÃµes sÃ£o clicÃ¡veis e habilitados" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Elementos principais (display, histÃ³rico) existem" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš¨ Casos Extremos" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ NÃºmeros grandes (99999 Ã— 99999)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ PrevenÃ§Ã£o de mÃºltiplos pontos decimais" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ SequÃªncia de operadores (trocar operador)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ambiente:**" >> $GITHUB_STEP_SUMMARY
        echo "- Framework: Jest + JSDOM" >> $GITHUB_STEP_SUMMARY
        echo "- SimulaÃ§Ã£o de DOM: Virtual (nÃ£o Ã© navegador real)" >> $GITHUB_STEP_SUMMARY
        echo "- Eventos testados: click, keydown, keyboard input" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ” Detalhamento: AnÃ¡lise de Qualidade de CÃ³digo" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ needs.code-quality.result == 'success' && 'âœ… PASSOU' || 'âš ï¸ AVISO' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**VerificaÃ§Ãµes Realizadas:**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ ESLint: AnÃ¡lise de padrÃµes de cÃ³digo JavaScript" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ npm audit: VerificaÃ§Ã£o de vulnerabilidades em dependÃªncias" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ SonarCloud: AnÃ¡lise estÃ¡tica de qualidade (se configurado)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ“Š EstatÃ­sticas do Pipeline" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total de Categorias de Testes:** 3" >> $GITHUB_STEP_SUMMARY
        echo "- Testes UnitÃ¡rios: FunÃ§Ãµes isoladas" >> $GITHUB_STEP_SUMMARY
        echo "- Testes de IntegraÃ§Ã£o: ~40+ cenÃ¡rios de uso simulados" >> $GITHUB_STEP_SUMMARY
        echo "- AnÃ¡lise de Qualidade: SeguranÃ§a e padrÃµes de cÃ³digo" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**CenÃ¡rios de Uso Cobertos:**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ OperaÃ§Ãµes matemÃ¡ticas bÃ¡sicas (4 tipos)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ OperaÃ§Ãµes especiais (2 tipos)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ InteraÃ§Ã£o via mouse (cliques em botÃµes)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ InteraÃ§Ã£o via teclado (entrada de dados)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Tratamento de erros (3 casos)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ OperaÃ§Ãµes complexas e encadeadas" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Casos extremos (nÃºmeros grandes, decimais)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## âš ï¸ ObservaÃ§Ãµes Importantes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Sobre os Testes de IntegraÃ§Ã£o (JSDOM)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Os testes classificados como \"E2E\" neste pipeline sÃ£o executados usando **Jest + JSDOM**, que simula um ambiente de navegador." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**âœ… O que Ã© testado:**" >> $GITHUB_STEP_SUMMARY
        echo "- LÃ³gica de interaÃ§Ã£o DOM (cliques, eventos)" >> $GITHUB_STEP_SUMMARY
        echo "- Fluxo completo de operaÃ§Ãµes" >> $GITHUB_STEP_SUMMARY
        echo "- ManipulaÃ§Ã£o de estado da aplicaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
        echo "- Comportamento de eventos de teclado" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**âš ï¸ O que NÃƒO Ã© testado (limitaÃ§Ãµes do JSDOM):**" >> $GITHUB_STEP_SUMMARY
        echo "- RenderizaÃ§Ã£o visual real (CSS, layout)" >> $GITHUB_STEP_SUMMARY
        echo "- Comportamento em navegadores reais (Chrome, Firefox, Safari)" >> $GITHUB_STEP_SUMMARY
        echo "- Responsividade real em diferentes resoluÃ§Ãµes" >> $GITHUB_STEP_SUMMARY
        echo "- AnimaÃ§Ãµes e transiÃ§Ãµes CSS" >> $GITHUB_STEP_SUMMARY
        echo "- Compatibilidade cross-browser" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ’¡ RecomendaÃ§Ã£o:**" >> $GITHUB_STEP_SUMMARY
        echo "Para validaÃ§Ã£o completa de produÃ§Ã£o, considere adicionar testes E2E reais com Playwright ou Cypress executados periodicamente." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.unit-tests.result }}" == "success" ] && [ "${{ needs.integration-tests.result }}" == "success" ]; then
          echo "## âœ… ConclusÃ£o: PIPELINE APROVADO" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Todos os testes passaram com sucesso. A aplicaÃ§Ã£o estÃ¡ pronta para deploy." >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ ConclusÃ£o: PIPELINE FALHOU" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Um ou mais conjuntos de testes falharam. Revise os logs acima para detalhes." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*RelatÃ³rio gerado automaticamente pelo GitHub Actions*" >> $GITHUB_STEP_SUMMARY