# .github/workflows/calculator-ci.yml
# Pipeline de CI/CD para a Calculadora

name: Calculator CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Job de Testes Unit√°rios
  unit-tests:
    name: Testes Unit√°rios
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3
    
    - name: Configurar Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Instalar depend√™ncias
      run: npm ci
    
    - name: Executar testes unit√°rios
      run: npm run test:unit
    
    - name: Gerar relat√≥rio de cobertura
      run: npm run test:coverage
    
    - name: Upload relat√≥rio de cobertura
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/coverage-final.json
        flags: unittests
        name: codecov-unit-tests

  # Job de Testes de Integra√ß√£o
  integration-tests:
    name: Testes de Integra√ß√£o
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3
    
    - name: Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Instalar depend√™ncias
      run: npm ci
    
    - name: Executar testes de integra√ß√£o
      run: npm run test:integration
    
    - name: Upload artefatos de testes
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: integration-test-results
        path: test-results/

  # Job de Testes E2E
  e2e-tests:
    name: Testes End-to-End
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3
    
    - name: Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Instalar depend√™ncias
      run: npm ci
    
    - name: Instalar Playwright browsers
      run: npx playwright install --with-deps
    
    - name: Iniciar servidor de desenvolvimento
      run: |
        npm start &
        npx wait-on http://localhost:3000
    
    - name: Executar testes E2E
      run: npm run test:e2e
    
    - name: Upload screenshots de falhas
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: e2e-screenshots
        path: test-results/
    
    - name: Upload v√≠deos de testes
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: e2e-videos
        path: test-results/videos/

  # Job de An√°lise de C√≥digo
  code-quality:
    name: An√°lise de Qualidade de C√≥digo
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Instalar depend√™ncias
      run: npm ci
    
    - name: Executar ESLint
      run: npm run lint
      continue-on-error: true
    
    - name: Executar an√°lise de seguran√ßa
      run: npm audit --audit-level=moderate
      continue-on-error: true
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      continue-on-error: true

  # Job de Build
  build:
    name: Build da Aplica√ß√£o
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests]
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3
    
    - name: Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Instalar depend√™ncias
      run: npm ci
    
    - name: Build da aplica√ß√£o
      run: npm run build
    
    - name: Upload artefatos de build
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: dist/

  # Job de Deploy (apenas em main)
  deploy:
    name: Deploy para Produ√ß√£o
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://calculator.example.com
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3
    
    - name: Download artefatos de build
      uses: actions/download-artifact@v3
      with:
        name: build-artifacts
        path: dist/
    
    - name: Deploy para servidor
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
    
    - name: Notifica√ß√£o de deploy bem-sucedido
      if: success()
      run: |
        echo "Deploy realizado com sucesso!"
        # Adicione aqui notifica√ß√µes via Slack, Discord, etc.

  # Job de Relat√≥rio de Testes
  test-report:
    name: Relat√≥rio Consolidado de Testes
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests]
    if: always()
    
    steps:
    - name: Gerar relat√≥rio consolidado
      run: |
        echo "## üìä Relat√≥rio de Testes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Testes Unit√°rios: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Testes de Integra√ß√£o: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Testes E2E: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY

---

# package.json - Scripts necess√°rios
{
  "name": "calculator-app",
  "version": "1.0.0",
  "description": "Calculadora web com testes completos",
  "scripts": {
    "start": "http-server -p 3000",
    "test": "jest",
    "test:unit": "jest --testMatch='**/*.test.js'",
    "test:integration": "jest --testMatch='**/*.integration.test.js'",
    "test:e2e": "playwright test",
    "test:coverage": "jest --coverage",
    "test:watch": "jest --watch",
    "lint": "eslint .",
    "build": "echo 'Build conclu√≠do'",
    "deploy": "echo 'Deploy iniciado'"
  },
  "devDependencies": {
    "@playwright/test": "^1.40.0",
    "@types/jest": "^29.5.0",
    "eslint": "^8.50.0",
    "http-server": "^14.1.1",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "wait-on": "^7.2.0"
  }
}

---

# jest.config.js - Configura√ß√£o do Jest
module.exports = {
  testEnvironment: 'jsdom',
  coverageDirectory: 'coverage',
  collectCoverageFrom: [
    '**/*.js',
    '!**/node_modules/**',
    '!**/coverage/**',
    '!jest.config.js'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  },
  testMatch: [
    '**/*.test.js',
    '**/*.integration.test.js'
  ]
};

---

# playwright.config.js - Configura√ß√£o do Playwright
const { defineConfig, devices } = require('@playwright/test');

module.exports = defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] },
    },
  ],
  webServer: {
    command: 'npm start',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});